(function(){var t="http://www.w3.org/2000/svg",e="http://www.w3.org/2000/xmlns/",i="http://www.w3.org/1999/xlink",s=function(s){c("INIT","Initialize etreecell canvas."),this.dom={canvas:document.getElementById(s)},this.svg={canvas:document.createElementNS(t,"svg")},this.saveValues={etreecell:["defaultAttr"],cell:["id","type","attr","data"],link:["id","attr","io","id","data"]},this.cell={},this.link={},this.cellTyper=r,this.defaultAttr={cell:{cell:{x:20,y:10,width:120,height:30,stroke:"black",fill:"none","stroke-width":2,rx:10,ry:10,"pointer-events":"visible",cursor:"pointer"},selected:{"etcl-margin-left":-12,"etcl-margin-right":-12,"etcl-margin-top":-12,"etcl-margin-bottom":-12,width:100,height:20,"etcl-float":"left,top,right,bottom","stroke-dasharray":"3, 3","stroke-width":2,stroke:"black",rx:7,ry:7,fill:"none"},resize:{"etcl-margin-right":-7,"etcl-margin-bottom":-7,"etcl-float":"right,bottom",width:10,height:10,cursor:"nw-resize",fill:"rgba(0,0,0,.2)","etcl-d":"M 10 10 L 0 10 L 10 0 Z"}},link:{line:{stroke:"black","stroke-width":2,fill:"none"}},helper:{css:{selector:".selector { opacity: 0; z-index:-1; transition: opacity .2s cubic-bezier(0.860, 0.000, 0.070, 1.000); } .selector.selected {opacity:.3; transition: opacity .2s cubic-bezier(0.860, 0.000, 0.070, 1.000); .selector.disable {display:none;} }",resize:".resize { opacity: 0; z-index:-1; transition: opacity .2s cubic-bezier(0.860, 0.000, 0.070, 1.000); } .resize.selected {opacity:1; transition: opacity .2s cubic-bezier(0.860, 0.000, 0.070, 1.000); } .resize.disable {display:none;}"}}},this.historyStack={undo:[],redo:[]},this.helper={output:[],input:[]},this.selected={cell:[],link:[]},c("INIT","Create & Append SVG Object"),this.svg.canvas.setAttribute("width","100%"),this.svg.canvas.setAttribute("height","100%"),this.svg.canvas.setAttributeNS(e,"xmlns:xlink",i),this.dom.canvas.appendChild(this.svg.canvas),this.initEvent(!0),this.creatable(!0),this.svg.canvas.etcl=this;var l="";for(var n in this.defaultAttr.helper.css)l+=this.defaultAttr.helper.css[n]+" ";this.createCSS(l)};s.prototype={createCell:function(t,e,i,s){c("ETCL","Create Cell.");var n=a(),r=this.cell[t||n]=new l(this,t||n,e||{},i||"textbox",s||{});return r},createLink:function(t,e,i,s){if(c("ETCL","Create Link."),this.link[t.id+"_"+e.id])return c("ETCL","This is existed link."),!1;var l=this.link[t.id+"_"+e.id]=new n(this,t,e,t.id+"_"+e.id,i||{},s||{});return l},getCellById:function(t){return c("ETCL","Get cell id : "+t),this.cell[t]||!1},getLinkById:function(t){return c("ETCL","Get link id : "+t),this.link[t]||!1},createCSS:function(t){var e=document.createElement("style");e.type="text/css",e.innerHTML=t,document.getElementsByTagName("head")[0].appendChild(e)},creatable:function(t){t&&this.svg.canvas.addEventListener("dblclick",function(t){this.etcl._draggingMove||this._draggingSelect||this.etcl.createCell(null,{x:t.clientX-this.etcl.defaultAttr.cell.cell.width/2-this.etcl.defaultAttr.cell.cell["stroke-width"],y:t.clientY-this.etcl.defaultAttr.cell.cell.height/2-this.etcl.defaultAttr.cell.cell["stroke-width"]})})},initEvent:function(t){this._draggingMove=!1,this._draggingSelect=!1,this._resizeMove=!1,this.svg.canvas.addEventListener("mousedown",function(t){c("ETCL","mousedown"),0==this.etcl.selected.cell.length,this.etcl._originPos={x:t.clientX,y:t.clientY};for(var e in this.etcl.selected.cell){var i=this.etcl.selected.cell[e];i._originPos={x:i.getAttr("x"),y:i.getAttr("y"),width:i.getAttr("width"),height:i.getAttr("height")}}}),this.svg.canvas.addEventListener("mousemove",function(t){if(this.etcl._draggingMove)for(var e in this.etcl.selected.cell){var i=this.etcl.selected.cell[e];i.setAttr({x:i._originPos.x+t.clientX-this.etcl._originPos.x,y:i._originPos.y+t.clientY-this.etcl._originPos.y})}if(this.etcl._resizeMove)for(var e in this.etcl.selected.cell){var i=this.etcl.selected.cell[e];i.setAttr({width:i._originPos.width+t.clientX-this.etcl._originPos.x<1?1:i._originPos.width+t.clientX-this.etcl._originPos.x,height:i._originPos.height+t.clientY-this.etcl._originPos.y<1?1:i._originPos.height+t.clientY-this.etcl._originPos.y})}}),this.svg.canvas.addEventListener("click",function(t){this.etcl._resizeMove||this.etcl.selectCell(),this.etcl._draggingMove=!1,this.etcl._resizeMove=!1})},exportToJson:function(){var t={etreecell:{},cell:{},link:{}};for(var e in this.saveValues.etreecell){var i=this.saveValues.etreecell[e];t.etreecell[i]=this[i]}for(var e in this.cell){var s=this.cell[e];t.cell[s.id]={};for(var l in this.saveValues.cell){var i=this.saveValues.cell[l];t.cell[s.id][i]=s[i]}}for(var e in this.link){var n=this.link[e];t.link[n.id]={};for(var l in this.saveValues.link){var i=this.saveValues.link[l];"io"==i?t.link[n.id].io={output:n[i].output.id,input:n[i].input.id}:t.link[n.id][i]=n[i]}}return c("EXPORT TO JSON",t),t},importFromJson:function(t){c("IMPORT FROM JSON",t);var e=JSON.parse(t);this.setDefaultAttr(e.etreecell.defaultAttr);for(var i in e.cell){var s=e.cell[i];this.createCell(s.id,s.attr,s.type,s.data)}for(var i in e.link){var l=e.link[i];this.createLink(this.getCellById(l.io.output),this.getCellById(l.io.input),l.attr,l.data)}return this},setDefaultAttr:function(t){return c("SET DEFAULT ATTR",t),this.defaultAttr=t,this},selectCell:function(t){for(var e in this.selected.cell)this.selected.cell[e].removeClass("selected");if(this.selected.cell.splice(0,this.selected.cell.length),!t)return this;if(t instanceof Array)for(var e in t)this.selected.cell.push(t[e]),t[e].addClass("selected");else this.selected.cell.push(t),t.addClass("selected");return this}};var l=function(t,e,i,s,l){c("CELL","Initialize Cell : "+e),this.etcl=t,this.id=e,this.type=s,this.attr={},this.io={input:[],output:[]},this.data=l,this.svg={cell:null,selected:null,resize:null},this.fit={drag:[],resize:[]},this.cellType=new r(t,this,s),this.eventList={dragstart:[],dragmove:[],dragend:[],editstart:[],editend:[]};for(var n in t.defaultAttr.cell.cell)this.attr[n]=t.defaultAttr.cell.cell[n];for(var n in i)this.attr[n]=i[n];return this.draw(),this.draggable(this.attr.draggable||!0),this};l.prototype={draw:function(){c("CELL","Draw cell"),this.svg.cell=document.createElementNS(t,"rect"),this.svg.cell.setAttributeNS(null,"id",this.id),this.svg.cell.cell=this,this.svg.cell.etcl=this.etcl,this.svg.cell.addEventListener("mousedown",function(t){this.cell.etcl._draggingMove=!0,this.cell.select()}),this.svg.cell.addEventListener("mousemove",function(t){}),this.svg.cell.addEventListener("mouseup",function(t){this.etcl._draggingMove=!1}),this.svg.cell.addEventListener("click",function(t){c("CELL","Click"),t.stopPropagation()}),this.svg.selected=document.createElementNS(t,"rect"),this.svg.selected.setAttributeNS(null,"id","selected_"+this.id),this.svg.selected.setAttributeNS(null,"class","selector");for(var e in this.etcl.defaultAttr.cell.selected)this.svg.selected.setAttributeNS(null,e,this.etcl.defaultAttr.cell.selected[e]);this.svg.selected.cell=this,this.svg.selected.etcl=this.etcl,this.svg.resize=document.createElementNS(t,"path"),this.svg.resize.setAttributeNS(null,"id","resize_"+this.id),this.svg.resize.setAttributeNS(null,"class","resize"),this.svg.resize.cell=this,this.svg.resize.etcl=this.etcl;for(var e in this.etcl.defaultAttr.cell.resize)this.svg.resize.setAttributeNS(null,e,this.etcl.defaultAttr.cell.resize[e]);return this.svg.resize.addEventListener("mousedown",function(t){this.cell.etcl._resizeMove=!0}),this.svg.resize.addEventListener("mousemove",function(t){}),this.svg.resize.addEventListener("mouseup",function(t){}),this.etcl.svg.canvas.appendChild(this.svg.selected),this.etcl.svg.canvas.appendChild(this.svg.resize),this.etcl.svg.canvas.appendChild(this.svg.cell),this.setAttr(this.attr),this.svg.cell},linkable:function(){},resizable:function(t){return t?d(this.svg.resize,"disable"):o(this.svg.resize,"disable"),this},editable:function(t){return t&&this.svg.cell.addEventListener("dblclick",function(t){t.stopPropagation()}),this},draggable:function(t){return c("CELL","Dragable"),this},focus:function(t){},select:function(){this.etcl.selectCell(this)},getAttr:function(t){return this.attr[t]||!1},getLinksByOutput:function(){var t=[];for(var e in this.io.output)t.push(this.etcl.getLinkById(this.io.output[e].id+"_"+this.id));return t},getLinksByInput:function(){var t=[];for(var e in this.io.input)t.push(this.etcl.getLinkById(this.id+"_"+this.io.input[e].id));return t},addFit:function(){},moveFit:function(t,e,i){var s=(t.getAttribute("etcl-float")||"left,top").replace("/ /gi","").split(","),l={x:0,y:0,width:0,height:0};switch(s.indexOf("left")!==-1&&(l.x=("x"==i?e:0)+parseInt(t.getAttribute("etcl-margin-left")||0)),s.indexOf("right")!==-1&&(l.x=("x"==i?e:this.getAttr("x"))+parseInt(this.getAttr("width"))-parseInt(t.getAttribute("width")||0)-parseInt(t.getAttribute("etcl-margin-right")||0)),s.indexOf("top")!==-1&&(l.y=("y"==i?e:0)+parseInt(t.getAttribute("etcl-margin-top")||0)),s.indexOf("bottom")!==-1&&(l.y=("y"==i?e:this.getAttr("y"))+parseInt(this.getAttr("height"))-parseInt(t.getAttribute("height")||0)-parseInt(t.getAttribute("etcl-margin-bottom")||0)),s.indexOf("left")!==-1&&s.indexOf("right")!==-1&&(l.width=("width"==i?e:0)+parseInt(t.getAttribute("etcl-margin-right")*-1||0)+parseInt(t.getAttribute("etcl-margin-left")*-1||0)),s.indexOf("top")!==-1&&s.indexOf("bottom")!==-1&&(l.height=("height"==i?e:0)+parseInt(t.getAttribute("etcl-margin-top")*-1||0)+parseInt(t.getAttribute("etcl-margin-bottom")*-1||0)),t.tagName){case"rect":t.setAttributeNS(null,i,l[i]);break;case"div":break;case"path":u(t,l.x,l.y)}return this},setAttr:function(t){c("CELL","Set the cell style.");var e=["id","d","x","y","width","height","stroke","fill","stroke-width","rx","ry","pointer-events"],i=["cursor"];if("object"==typeof t)for(var s in t)e.indexOf(s)!==-1?(this.svg.cell.setAttributeNS(null,s,t[s]),this.attr[s]=t[s],"x"!=s&&"y"!=s&&"width"!=s&&"height"!=s||(this.moveFit(this.svg.selected,t[s],s),this.moveFit(this.svg.resize,t[s],s))):i.indexOf(s)!==-1&&(this.svg.cell.style[s]=t[s],this.attr[s]=t[s]);var l=this.getLinksByOutput();for(var n in l)l[n].updateLine();var r=this.getLinksByInput();for(var n in r)r[n].updateLine();return this},addEvent:function(t,e){return this.eventList[t].push(e),this},linkTo:function(t,e){return c("LINK","Link to "+t.id),this.etcl.createLink(this,t,e||[]),this},addClass:function(t){return o(this.svg.cell,t),o(this.svg.selected,t),o(this.svg.resize,t),this},removeClass:function(t){return d(this.svg.cell,t),d(this.svg.selected,t),d(this.svg.resize,t),this},hasClass:function(t){return h(this.svg.cell,t)}};var n=function(t,e,i,s,l,n){c("LINK","Initialize Link."+s),this.etcl=t,this.id=s,this.attr={},this.data=n,this.svg={line:null,text:null},this.io={output:e,input:i};for(var r in t.defaultAttr.link.line)this.attr[r]=t.defaultAttr.link.line[r];for(var r in l)this.attr[r]=l[r];e.io.input.push(i),i.io.output.push(e),this.draw()};n.prototype={draw:function(){return c("LINK","Draw link"),this.svg.line=document.createElementNS(t,"path"),this.svg.line.setAttributeNS(null,"id",this.id),this.setAttr(this.attr),this.etcl.svg.canvas.appendChild(this.svg.line),this.svg.line.link=this,this.svg.line.etcl=this.etcl,this.updateLine(),this.svg.line},updateLine:function(){this.drawLine(this.io.output.getAttr("x"),this.io.output.getAttr("y"),this.io.output.getAttr("width"),this.io.output.getAttr("height"),this.io.output.getAttr("stroke-width"),this.io.input.getAttr("x"),this.io.input.getAttr("y"),this.io.input.getAttr("width"),this.io.input.getAttr("height"),this.io.input.getAttr("stroke-width"))},drawLine:function(t,e,i,s,l,n,r,a,h,o){c("LINK","draw line of link");for(var d=[{x:t+i/2,y:e-l/2},{x:t+i/2,y:e+s+l/2},{x:t-l/2,y:e+s/2},{x:t+i+l/2,y:e+s/2},{x:n+a/2,y:r-o/2},{x:n+a/2,y:r+h+o/2},{x:n-o/2,y:r+h/2},{x:n+a+o/2,y:r+h/2}],u={},g=[],v=0;v<4;v++)for(var f=4;f<8;f++){var p=Math.abs(d[v].x-d[f].x),y=Math.abs(d[v].y-d[f].y);(v==f-4||(3!=v&&6!=f||d[v].x<d[f].x)&&(2!=v&&7!=f||d[v].x>d[f].x)&&(0!=v&&5!=f||d[v].y>d[f].y)&&(1!=v&&4!=f||d[v].y<d[f].y))&&(g.push(p+y),u[g[g.length-1]]=[v,f])}var x;x=0==g.length?[0,4]:u[Math.min.apply(Math,g)];var t=d[x[0]].x,e=d[x[0]].y,A=d[x[1]].x,b=d[x[1]].y;p=Math.max(Math.abs(t-A)/2,10),y=Math.max(Math.abs(e-b)/2,10);var n=[t,t,t-p,t+p][x[0]].toFixed(3),r=[e-y,e+y,e,e][x[0]].toFixed(3),m=[0,0,0,0,A,A,A-p,A+p][x[1]].toFixed(3),w=[0,0,0,0,e+y,e-y,b,b][x[1]].toFixed(3);return this.svg.line.setAttributeNS(null,"d",["M",t.toFixed(3),e.toFixed(3),"C",n,r,m,w,A.toFixed(3),b.toFixed(3)].join(" ").toString()),this},addEvent:function(t,e){this.eventList[t].push(e)},setAttr:function(t){c("LINK","Set the link style.");var e=["id","d","x","y","width","height","stroke","fill","stroke-width","rx","ry","pointer-events"],i=["cursor"];if("object"==typeof t)for(var s in t)e.indexOf(s)!==-1?(this.svg.line.setAttributeNS(null,s,t[s]),this.attr[s]=t[s]):i.indexOf(s)!==-1&&(this.svg.line.style[s]=t[s],this.attr[s]=t[s]);return this},setData:function(t){for(var e in t)this.data[e]=t[e];return this},getData:function(t){return this.data(t)},getAttr:function(){return this.attr[attr]||!1}};var r=function(t,e,i){this.etcl=t,this.cell=e,this.cellType=i;try{this[i](t,e)}catch(t){c("CELL TYPER","This is not valid cell type.")}};r.prototype={textbox:function(t,e){}};var c=function(t,e){var i=!0;i&&("object"==typeof e&&(e=JSON.stringify(e)),console.log("[ETREECELL] ["+t+"] "+e))},a=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},h=function(t,e){return t.classList?t.classList.contains(e):!!t.className.match(new RegExp("(\\s|^)"+e+"(\\s|$)"))},o=function(t,e){t.classList?t.classList.add(e):h(t,e)||(t.className+=" "+e)},d=function(t,e){if(t.classList)t.classList.remove(e);else if(h(t,e)){var i=new RegExp("(\\s|^)"+e+"(\\s|$)");t.className=t.className.replace(i," ")}},u=function(t,e,i){var s=t.getAttribute("etcl-d").split(" "),l=!0;for(var n in s)isNaN(parseInt(s[n]))||(l?s[n]=parseInt(s[n])+e:s[n]=parseInt(s[n])+i,l=!l);return t.setAttributeNS(null,"d",s.join(" ")),s.join(" ")};window.etcl=window.etreecell=s,window.etclCellTyper=window.etreecellCellTyper=window.etclct=r})(window);